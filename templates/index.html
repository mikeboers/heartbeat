{% extends "_main.html" %}
{% block body %}

<h3>Services</h3>

<table class="table table-striped table-hover">
    <thead><tr>
        <td>Status
        <td>Name
        <td>Last Time
        <td>Last Origin
        <td>Actions
    <tbody>
    {% for service in services %}
        <tr class="service"
            data-pk="{{ service.id }}"
            data-can-active-check="{{ 'true' if service.can_active_check else 'false' }}"
            data-heartbeat-count="{{ service.heartbeats | length }}"
        >
            <td>
                {% if service.heartbeats %}
                    {% for content, type_ in service.last_beat.labels() %}
                        <span class="label label-{{ type_ }}">{{ content }}</span>
                    {% endfor %}
                {% endif %}

            <td>
                <a href="{{ url_for('service_details', name=service.name) }}">
                    <strong>{{ service.name }}</strong>
                </a>

            <td>
                {% if service.heartbeats %}
                    {{ service.last_beat.time | timedeltaformat }}<br/>
                    <small>{{ service.last_beat.time | datetimeformat('d MMMM, yyyy h:mm:ss a z') }}</small>
                {% else %}
                    <em>never</em>
                {% endif %}

            <td>
                {% if service.heartbeats %}
                    {{ service.last_beat.remote_name }}<br/>
                    <small>{{ service.last_beat.remote_addr }}</small>
                {% else %}
                    <em>never</em>
                {% endif %}

            <td class="service-actions btn-group">
                &nbsp;

    {% endfor %}
    <tr>
        <td>&nbsp;
        <td colspan="4"><form class="form-inline" method="POST" action="{{ url_for('create_service_api') }}">
            <input type="text" name="name" />
            <input type="submit" class="btn btn-primary" value="Create" />
        </form>

</table>


{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>


        // Delete buttons
        $('.service-actions').each(function() {

            var $service = $(this).closest('.service')

            var checkBtn = $('<a />', {
                'class': "service-check-btn btn btn-mini",
                html: '<i class="icon-ok"></i> Check',
                disabled: !$service.data('canActiveCheck')
            })
                .appendTo(this);

            $('<a />', {
                'class': "service-delete-btn btn btn-mini btn-danger",
                html: '<i class="icon-trash icon-white"></i> Delete'
            })
                .appendTo(this);

        });

        $('.service-check-btn').click(function() {
            var $service = $(this).closest('.service');
            $.post({{ url_for('check_service_api') |tojson|safe }}, {
                id: $service.data('pk')
            });
        })
        $('.service-delete-btn').click(function() {
            var $service = $(this).closest('.service');
            $.post({{ url_for('delete_service_api') |tojson|safe }}, {
                id: $service.data('pk')
            });
            $service.fadeOut();
        });
           

    </script>
{% endblock %}